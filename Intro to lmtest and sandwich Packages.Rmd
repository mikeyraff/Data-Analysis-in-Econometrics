---
title: "Econ 695 Problem Set 2"
output: pdf_document
---

Your name: Michael Raffanti

Your NetID: raffanti

## Load the data and the packages

To begin with, load the data (and the packages necessary for your work).

```{r, message = FALSE}
setwd("/Users/mikeyraffanti/Documents/econ695/Problem Set 2")
data = read.csv("levinson_new.csv", header = TRUE, sep = ",")
library(nlme)
library(sandwich)
library(lmtest)
```


## Question 1

What are the average tax rate and waste shipment size in the data? How about the conditional averages of the tax rate and the shipment size, for (1) no tax vs. any tax; and (2) in-state (meaning that the origin state is the same as the destination state) vs. out-of-state shipment?

```{r}
average_tax = mean(data$tax, na.rm = TRUE)
average_shipment_size = mean(data$shipments, na.rm = TRUE)

no_tax_average_tax = mean(data$tax[data$tax == 0], na.rm = TRUE)
no_tax_average_shipment_size = mean(data$shipments[data$tax == 0], na.rm = TRUE)
any_tax_average_tax = mean(data$tax[data$tax > 0], na.rm = TRUE)
any_tax_average_shipment_size = mean(data$shipments[data$tax > 0], na.rm = TRUE)

in_state_average_tax = mean(data$tax[data$orig_id == data$dest_id], na.rm = TRUE)
in_state_average_shipment_size = mean(data$shipments[data$orig_id == data$dest_id], na.rm = TRUE)

out_of_state_average_tax = mean(data$tax[data$orig_id != data$dest_id], na.rm = TRUE)
out_of_state_average_shipment_size = mean(data$shipments[data$orig_id != data$dest_id], na.rm = TRUE)

averages_table = data.frame(Category = c("Overall", "No Tax", "Any Tax", "In-State", "Out-of-State"), Average_Tax = c(average_tax, no_tax_average_tax, any_tax_average_tax, in_state_average_tax, out_of_state_average_tax), Average_Shipment_Size = c(average_shipment_size, no_tax_average_shipment_size, any_tax_average_shipment_size, in_state_average_shipment_size, out_of_state_average_shipment_size))

print(averages_table)
```

*Answer:* 


## Question 2

### Part 2-A

Consider a model of waste shipments to better understand the determinants of waste shipments. 
\[
\log(\text{Shipment}_{ijt}) = \beta\text{Tax}_{ijt}+\mathbf{X}_{it} + \delta\mathbf{X}_{ijt} + \tau_t+ \epsilon_{ijt},
\]
where $i$ denotes the origin state, $j$ the destination state, $t$ the year of shipment, $\mathbf{X}_{ijt}$ a vector of characteristics of states $i$ and $j$, and $\tau_t$ year dummies. Components of $\mathbf{X}_{ijt}$ include (i) a dummy indicating whether the shipment is in-state (i.e., $i=j$), (ii) the natural log of the amount of waste generated by the origin state (`ogen`), (iii) distance between the two states and the distance squared, (iv) the origin and destination states' median income, area, population, population density, hazardous waste capacity, and population percentages over age 65 and with college degrees, and (v) the destination region dummies (based on `dregion`).

Present your regression results and report both the robust standard errors and standard errors adjusted for clustering at the destination state level.

```{r, warning=F}
# First Regression for Robust Standard Errors
data$log_shipments = log(data$shipments)
data$log_ogen = log(data$ogen)
data$in_state_dummy = ifelse(data$orig_id == data$dest_id, 1, 0)
clean_data = data[!is.na(data$log_shipments) & !is.infinite(data$log_shipments), ]
clean_data = na.omit(clean_data)
model = lm(log_shipments ~ tax + in_state_dummy + log_ogen + oinc + dinc + opop + dpop + oarea + darea + odens + ddens + ocap + dcap + o65 + d65 + ocoll + dcoll, data = clean_data)
summary(model)
```

```{r}
# Second Regression for Adjusted for Clustering 
adjusted_model = coeftest(model, vcov = vcovHC(model, type = "HC1", cluster = "group"))
summary(adjusted_model)
```


### Part 2-B
Based on the results, how does the waste shipment respond to the tax? Interpret the coefficient for $Tax_{ijt}$ in words.

The coefficient for tax in this regression model tells us how the natural log of waste shipments responds to a one-unit increase in the tax rate, holding all other variables constant. Since the coefficient is negative, it suggests that higher taxes on waste shipments lead to a decrease in the volume of waste shipped, adjusting for the other factors in the model.

*Answer:* 


### Part 2-C
How does the statistical significance of the coefficient estimate change as we adjust the standard errors for clustering? Discuss.

Adjusting for clustering in regression analysis leads to larger standard errors, which impacts the statistical significance of coefficients. Without this adjustment, standard errors may be underestimated due to ignored correlations within clusters, overstating the significance of variables such as taxes on waste shipments. Once adjusted, the significance of these coefficients, including the tax rate, can decrease, suggesting their effects might have been overstated initially.

*Answer:* 

## Question 3

### Part 3-A

What fraction of the observations have zero shipment size?

```{r}
fraction = sum(data$shipments == 0) / nrow(data)
print(fraction)
```

*Answer:* 

### Part 3-B

How does this affect the interpretation of the coefficient estimates in terms of sample selection bias? Discuss.

The regression results only apply to situations where shipments occur, ignoring the decision process or factors leading to zero shipments. As for the bias in coefficient estimates, if the determinants of having zero shipments are correlated with the explanatory variables, the estimated coefficients may be biased. This bias affects the interpretation of how tax rates influence waste shipments.

*Answer:* 


## Question 4

### Part 4-A

To address the issue mentioned in Question 3, we consider three alternative outcome variables. First, we use the logarithm of the shipment size plus one, $\log(\text{Shipment}_{ijt}+1)$, which allows us to include all observations. Second, we use the logarithm of the shipment size plus 0.001, $\log(\text{Shipment}_{ijt}+0.001)$. Third, we instead focus on an extensive margin, by a dummy indicating whether there was any nonzero shipment. Present the regression results of these three specifications, along with those from Question 2, in one table. Adjust your standard errors for clustering at the destination state level. 

```{r}
data$log_shipment_plus_one = log(data$shipments + 1)
data$log_shipment_plus_point = log(data$shipments + 0.001)
data$nonzero_shipment_dummy = as.integer(data$shipments > 0)
```


```{r, warning=F}
model1 = lm(log_shipment_plus_one ~ tax + in_state_dummy + log_ogen + oinc + dinc + opop + dpop + oarea + darea + odens + ddens + ocap + dcap + o65 + d65 + ocoll + dcoll, data = data)
model2 = lm(log_shipment_plus_point ~ tax + in_state_dummy + log_ogen + oinc + dinc + opop + dpop + oarea + darea + odens + ddens + ocap + dcap + o65 + d65 + ocoll + dcoll, data = data)
model3 = lm(nonzero_shipment_dummy ~ tax + in_state_dummy + log_ogen + oinc + dinc + opop + dpop + oarea + darea + odens + ddens + ocap + dcap + o65 + d65 + ocoll + dcoll, data = data)

model1_clustered = coeftest(model1, vcov = vcovHC(model1, type = "HC1", cluster = ~dest_id))
```

```{r}
tax_details = function(model) {
  coef_summary = summary(model)$coefficients["tax", ]
  return(coef_summary)
  }

details_model1 = tax_details(model1)
details_model2 = tax_details(model2)
details_model3 = tax_details(model3)
details_model4 = tax_details(model)

results_table = data.frame(Model = c("Log(Shipments+1)", "Log(Shipments+0.001)", "Nonzero Shipment Dummy", "Original Log(Shipments)"), Coefficient = c(details_model1["Estimate"], details_model2["Estimate"], details_model3["Estimate"], details_model4["Estimate"]), StdError = c(details_model1["Std. Error"], details_model2["Std. Error"], details_model3["Std. Error"], details_model4["Std. Error"]), tValue = c(details_model1["t value"], details_model2["t value"], details_model3["t value"], details_model4["t value"]), pValue = c(details_model1["Pr(>|t|)"], details_model2["Pr(>|t|)"], details_model3["Pr(>|t|)"], details_model4["Pr(>|t|)"]))

print(results_table)
```


### Part 4-B

Based on the regression results, how does the waste shipment respond to the tax?

After compiling the results within a table, it can be seen that all the coefficients are negative and very small numbers. A negative coefficient indicates that higher taxes lead to a decrease in waste shipments. For the log-transformed shipment size, it means that as taxes increase, the shipment size decreases. In the context of the dummy variable model, a negative coefficient would suggest that higher taxes decrease the probability of having any shipments. This outcome aligns with the expected deterrent effect of taxes on waste shipments. 

*Answer:* 


## Question 5

### Part 5-A

Let us conduct a robustness check by controlling for destination state and original state dummies, focusing on two outcome variables ($\log(\text{Shipment}_{ijt}+1)$ and the dummy for nonzero shipment). Note that by including the destination state dummies in the regression, we can control for everything about the destination states (which doesn't change over time) that might make them attractive to dumpers.\footnote{When you include destination state fixed effects, you will no longer be able to include the time-invariant observable destination state attributes. This is because the regression wouldn’t be able to tell them apart from the fixed effects – i.e., the fixed effects will capture the effects of all of those attributes, as well as any unobserved attributes that don’t vary over time.} Similarly, by including the origin state dummies, we can control for everything about the origin states that might make them become a dumper. 

Present the regression results of the two specifications (for each of the two different outcomes), along with the results of the corresponding two specifications from Question 4 for comparison, in a table. Adjust your standard errors for clustering at the destination state level. 

```{r, warning=F}
data$orig_id = as.factor(data$orig_id)
data$dest_id = as.factor(data$dest_id)
orig_dummies = model.matrix(~ orig_id - 1, data = data)
dest_dummies = model.matrix(~ dest_id - 1, data = data)
data = cbind(data, orig_dummies, dest_dummies)

model_with_dummies = lm(log_shipment_plus_one ~ tax + in_state_dummy + log_ogen + oinc + dinc + opop + dpop + oarea + darea + odens + ddens + ocap + dcap + o65 + d65 + ocoll + dcoll + orig_dummies + dest_dummies, data = data)
model_nonzero_with_dummies = lm(nonzero_shipment_dummy ~ tax + in_state_dummy + log_ogen + oinc + dinc + opop + dpop + oarea + darea + odens + ddens + ocap + dcap + o65 + d65 + ocoll + dcoll + orig_dummies + dest_dummies, data = data)

model1_clustered = coeftest(model_with_dummies, vcov = vcovHC(model_with_dummies, type = "HC1", cluster = ~dest_id))
```

### Part 5-B

How does the estimate for $\beta$ change as we add destination and origin state dummies? 

Look at how the inclusion of state dummies affects the tax coefficient's magnitude and statistical significance. Adding these controls reduces omitted variable bias, leading to more accurate estimates of the tax effect.

*Answer:* 